#!/bin/sh
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup script, version 3.9.6
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != "true" ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

# set JAVACMD and JAVACMD_ARGS
set_java_home() {
  # For Cygwin and MinGW, ensure paths are in Unix format before anything is touched
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      # IBM's JDK on AIX uses strange locations for the executables
      JAVACMD="$JAVA_HOME/jre/sh/java"
    else
      JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ]; then
      echo "Error: JAVA_HOME is set to an invalid directory: $JAVA_HOME" >&2
      echo "Please set the JAVA_HOME variable in your environment to match the" >&2
      echo "location of your Java installation." >&2
      exit 1
    fi
  else
    JAVACMD="java"
    if ! command -v java >/dev/null 2>&1
    then
      echo "Error: JAVA_HOME is not set and no 'java' command could be found in your PATH." >&2
      echo "Please set the JAVA_HOME variable in your environment to match the" >&2
      echo "location of your Java installation." >&2
      exit 1
    fi
  fi
}

# hash string like Java String::hashCode
hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %s\\n "$h"
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != "true" ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

# parse distributionUrl and optional distributionSha256Sum, requires .mvn/wrapper/maven-wrapper.properties
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl="${value-}" ;;
  distributionSha256Sum) distributionSha256Sum="${value-}" ;;
  esac
done <"${0%/*}/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl property in ${0%/*}/.mvn/wrapper/maven-wrapper.properties"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  case "${PROCESSOR_ARCHITECTURE-}${PROCESSOR_ARCHITEW6432-}:$(uname -a)" in
  *AMD64:CYGWIN* | *AMD64:MINGW*) distributionPlatform=windows-amd64 ;;
  :Darwin*x86_64) distributionPlatform=darwin-amd64 ;;
  :Darwin*arm64) distributionPlatform=darwin-aarch64 ;;
  :Linux*x86_64*) distributionPlatform=linux-amd64 ;;
  *)
    echo "Cannot detect native platform for mvnd on $(uname)-$(uname -m), use pure java version" >&2
    distributionPlatform=linux-amd64
    ;;
  esac
  distributionUrl="${distributionUrl%-bin.*}-$distributionPlatform.zip"
  ;;
maven-mvnd-*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
*) MVN_CMD="mvn${0##*/mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

# apply MVNW_REPOURL and calculate MAVEN_HOME
# maven home pattern: ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>/<apachemaven|mvnd>-<version>
[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain#apache-}"
distributionUrlNameMain="${distributionUrlNameMain#maven-}"
distributionUrlNameMain="${distributionUrlNameMain#mvnd-}"
USER_MAVEN_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${USER_MAVEN_HOME}/wrapper/dists/${distributionUrlNameMain}/$(hash_string "$distributionUrl")/${distributionUrlNameMain}"

exec_maven() {
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

if [ -d "$MAVEN_HOME" ]; then
  verbose "found existing MAVEN_HOME at $MAVEN_HOME"
  exec_maven "$@"
fi

case "${distributionUrl}" in
*?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
*) die "distributionUrl is not valid, must match *-bin.zip or maven-mvnd-*.zip, got ${distributionUrl}" ;;
esac

# prepare tmp dir
if TMP_DOWNLOAD_DIR="$(mktemp -d)" && [ -d "$TMP_DOWNLOAD_DIR" ]; then
  clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
  trap clean HUP INT TERM EXIT
else
  die "cannot create temp dir"
fi

mkdir -p -- "${MAVEN_HOME%/*}"

# Download and Install Apache Maven + wrapper in ~/.m2/wrapper/dists/{apache-maven-<version>,maven-mvnd-<version>-<platform>}/<hash>/<apachemaven|mvnd>-<version>
# If the maven home exists, validate the SHA-256 sum and attempt to install anyway
verbose "Downloading $distributionUrl"
while IFS="=" read -r key value; do
  case "$key" in wrapperUrl) wrapperUrl="$value" ;; esac
done <"${0%/*}/.mvn/wrapper/maven-wrapper.properties"
[ -n "${wrapperUrl-}" ] \
  || wrapperUrl="https://repo.maven.apache.org/maven2/org/apache/maven/wrapper/maven-wrapper/3.9.6/maven-wrapper-3.9.6.jar"
while IFS="=" read -r key value; do
  case "$key" in wrapperSha256Sum) wrapperSha256Sum="$value" ;; esac
done <"${0%/*}/.mvn/wrapper/maven-wrapper.properties"
[ -n "${wrapperSha256Sum-}" ] \
  || wrapperSha256Sum="5b25df056cfd61b8fbde7670b87b465b10effccef3344b3b4db22c9b3e7ab531"

if command -v curl >/dev/null; then
  verbose "Found curl"
  if [ -z "${MVNW_USERNAME-}" ] && [ -z "${MVNW_PASSWORD-}" ]; then
    curl() { \env curl --silent --fail --location --retry 3 "$@"; }
  else
    curl() { \env curl --silent --fail --location --retry 3 --user "${MVNW_USERNAME}:${MVNW_PASSWORD}" "$@"; }
  fi
elif command -v wget >/dev/null; then
  verbose "Found wget"
  if [ -z "${MVNW_USERNAME-}" ] && [ -z "${MVNW_PASSWORD-}" ]; then
    wget() { \env wget --quiet --tries=3 -O - "$@"; }
  else
    wget() { \env wget --quiet --tries=3 --http-user="${MVNW_USERNAME}" --http-password="${MVNW_PASSWORD}" -O - "$@"; }
  fi
elif command -v busybox >/dev/null && [ -x "$(command -v busybox)" ]; then
  verbose "Found busybox"
  if [ -z "${MVNW_USERNAME-}" ] && [ -z "${MVNW_PASSWORD-}" ]; then
    wget() { busybox wget --quiet -O - "$@"; }
  else
    die "busybox wget doesn't support authentication via MVNW_USERNAME and MVNW_PASSWORD"
  fi
else
  die "cannot find curl, wget, or busybox wget"
fi

# For old Maven or JDK versions, use only TLS 1.2
case "$(exec "$JAVACMD" -cp .mvn/wrapper maven-wrapper MavenWrapperDownloader "PRINT_JAVA_VERSION" 2>/dev/null || :)" in
"1."[0-7]"."* | "9" | "10") HTTPS_PROTOCOLS=TLSv1.2 ;;
*) HTTPS_PROTOCOLS=TLSv1.2,TLSv1.3 ;;
esac
verbose "https ssl protocols: ${HTTPS_PROTOCOLS}"

if [ -z "${distributionSha256Sum-}" ]; then
  while read -r url; do
    verbose "Downloading $url"
    case "$url" in
    *?-bin.zip) curl -o "$TMP_DOWNLOAD_DIR/${distributionUrlName}" "$url" && break ;;
    maven-mvnd-?*-?*.zip) curl -o "$TMP_DOWNLOAD_DIR/${distributionUrlName}" "$url" && break ;;
    esac
  done <<EOM
${distributionUrl}
EOM
else
  while read -r url; do
    verbose "Downloading $url"
    case "$url" in
    *?-bin.zip) curl -o "$TMP_DOWNLOAD_DIR/${distributionUrlName}" "$url" && break ;;
    maven-mvnd-?*-?*.zip) curl -o "$TMP_DOWNLOAD_DIR/${distributionUrlName}" "$url" && break ;;
    esac
  done <<EOM
${distributionUrl}.sha256
${distributionUrl}
EOM
fi

# If specified, validate the SHA-256 sum of the Maven distribution zip file
if [ -n "${distributionSha256Sum-}" ]; then
  distributionSha256Result=false
  if [ "$MVN_CMD" = mvn.cmd ]; then
    echo "Comparing to... ${distributionSha256Sum}"
    if [ -f "$TMP_DOWNLOAD_DIR/${distributionUrlName}.sha256" ]; then
      distributionSha256Result=$(cat "$TMP_DOWNLOAD_DIR/${distributionUrlName}.sha256")
    fi
  elif command -v shasum >/dev/null; then
    echo "Validating Maven distribution SHA-256 checksum"
    distributionSha256Result=$(shasum -a 256 "$TMP_DOWNLOAD_DIR/${distributionUrlName}" | cut -f 1 -d ' ')
  elif command -v sha256sum >/dev/null; then
    echo "Validating Maven distribution SHA-256 checksum"
    distributionSha256Result=$(sha256sum "$TMP_DOWNLOAD_DIR/${distributionUrlName}" | cut -f 1 -d ' ')
  else
    echo "Checksum validation was requested but neither 'shasum' nor 'sha256sum' are available."
    echo "Please install either command, or disable validation by removing 'distributionSha256Sum' from your maven-wrapper.properties."
    exit 1
  fi
  if [ "$distributionSha256Result" != "$distributionSha256Sum" ]; then
    echo "Error: Failed to validate Maven distribution SHA-256, your Maven distribution might be compromised." >&2
    echo "If you updated your Maven version, you need to update the specified wrapperSha256Sum property." >&2
    exit 1
  fi
fi

# unzip and move
if command -v unzip >/dev/null; then
  unzip -q "$TMP_DOWNLOAD_DIR/${distributionUrlName}" -d "$TMP_DOWNLOAD_DIR"
else
  die "cannot find unzip"
fi

verbose "Installing $MAVEN_HOME"
mkdir -p -- "${MAVEN_HOME}"
mv -- "$TMP_DOWNLOAD_DIR"/*/"${distributionUrlNameMain}" "$MAVEN_HOME" || \
mv -- "$TMP_DOWNLOAD_DIR"/"${distributionUrlNameMain}" "$MAVEN_HOME"

clean || :
exec_maven "$@"
